# Discourse Hosting

This repository contains the code for running Discourse locally .

This does not use the Docker images provided by discourse, instead opting to build a new one, so that each
service can be broken up into its own docker container and we can build it with more traditional Docker tools
instead of the wrapper provided by Discourse.



## Local Development with Docker Compose

First populate the .env file with the following:

```shell
SEND_GRID_API_KEY=...
HOSTNAME=forum.mydomain.com
EMAIL=my-email@gmail.com
# Run openssl rand -hex 32 to generate a new secret key
SECRET_KEY=...
# Generated by the glitchtip server after creating an account
DSN=http://...@glitchtip.${HOSTNAME}/1
```

Then make modify your `/etc/hosts` file to alias your domain to localhost:

```shell
127.0.0.1 forum.mydomain.com
127.0.0.1 assets.forum.mydomain.com
127.0.0.1 glitchtip.forum.mydomain.com
```

Then run the following commands:


```shell
docker compose run --rm glitchtip-migrate
docker compose run --rm migrate
docker compose run --rm upload_assets
docker compose run --rm install_themes
docker compose up web glitchtip-worker
```


Now open your browser to http://forum.mydomain.com and you should see the Discourse setup page.

You can also visit `/logs` to see the logs and `/sidekiq` to see the sidekiq dashboard.

You can also visit http://localhost:8001 to see the redis GUI, use the password `password`.

The Minio GUI is available at http://localhost:9001. The default username and pw is `minioadmin`.

To import emails:

```shell
mkdir -p data/import/emails
cp some-mailbox.mbox data/import/emails
# Copy the default settings to the `data/import/` setting.
docker-compose run -v $PWD/data/import:/shared/import/data --rm web bundle exec ruby script/import_scripts/mbox.rb /shared/import/data/settings.yml
```

To remove all the data, run:

```shell
docker compose down -v
rm -rf data/*/**
```


## Debugging

### Network Traffic

If you want to see the network traffic from one of the containers, for debugging purposes, you can use tcpdump and wireshark:

```bash
dc run --rm --name tmp web bash -i
docker run --net=container:tmp maintained/tcpdump -i any -w - | wireshark -k -i -
# create network traffic in initial container
#  bundle exec rake s3:upload_assets
```

## Rails Console

If we want to check how something works on the ruby side, we can do that with rails console. Here is an example of how to do that
to see how the `preload_script` helper works:

```shell
docker compose run --rm web bundle exec rails c
```


```ruby
require 'mock_redis'
require 'rspec-html-matchers'
require "ostruct"
require_relative './spec/rails_helper'
helper.request = OpenStruct.new(:env => {'HTTP_ACCEPT_ENCODING' => 'gzip, deflate'})
helper.preload_script("vendor")
ActionController::Base.helpers.asset_path("vendor.js")
```

## About

We run the sidekiq alongside the web process in the same container. This is so that they can share a mounted volume [in Render](https://render.com/docs/disks) which cannot be shared accross containers. Alternatively,
we could set everything up to use a third party service like S3 for uploads and assets.
